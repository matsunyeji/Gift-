<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Birthday Race — Game</title>
<style>
  html,body{height:100%;margin:0;background:#061226;font-family:Inter,system-ui,Arial;color:#fff;overflow:hidden}
  #gameParent{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
  canvas{display:block;background:transparent;max-width:100%;height:auto;border-radius:6px;box-shadow:0 18px 60px rgba(0,0,0,0.6)}
  #ui{position:absolute;left:14px;top:12px;z-index:40;display:flex;align-items:center;gap:12px}
  #hearts{display:flex;gap:6px;align-items:center}
  .heart{width:28px;height:28px;background: url('data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path fill=\"%23ff6aa6\" d=\"M12 21s-7-4.35-9-7.18C-1.2 9.9 3.3 4 8.6 6.2 10 7 11.6 8.2 12 9c.4-.8 2-2 3.4-2.8 5.3-2.2 9.8 3.7 5.6 7.6C19 16.65 12 21 12 21z\"/></svg>') center/contain no-repeat}
  #score{font-weight:700;color:#ffd1e8;text-shadow:0 0 8px rgba(255,100,180,0.12)}
  #controls{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);display:flex;gap:12px;z-index:50}
  .ctl{width:64px;height:56px;border-radius:12px;background:rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;user-select:none}
  #overlay{position:fixed;inset:0;background:linear-gradient(180deg,rgba(5,8,18,0.6),rgba(5,8,18,0.8));display:none;align-items:center;justify-content:center;flex-direction:column;gap:12px;z-index:100}
  #overlay h2{font-size:2rem;margin:0}
  #overlay button{padding:12px 18px;border-radius:12px;border:none;background:#ff4fa3;color:#fff;font-weight:700;cursor:pointer}
  /* small screen tweaks */
  @media (max-width:420px){ canvas{width:100vw;height:calc(100vw*1.6)} .ctl{width:72px;height:60px;font-size:22px} }
</style>
</head>
<body>
<div id="gameParent">
  <canvas id="game" width="420" height="720" aria-label="Birthday racing game"></canvas>


  <!-- UI -->
  <div id="ui">
    <div id="hearts" aria-hidden="true"></div>
    <div id="score">Score: 0</div>
  </div>

  <!-- touch controls -->
  <div id="controls">
    <div id="left" class="ctl">◀</div>
    <div id="right" class="ctl">▶</div>
  </div>

  <!-- overlay (pause or game over) -->
  <div id="overlay">
    <h2 id="overlayTitle">Game Over</h2>
    <div id="overlayMessage">Final score: <span id="finalScore">0</span></div>
    <div style="display:flex;gap:12px">
      <button id="restartBtn">Restart</button>
      <button id="backBtn">Back to Card</button>
    </div>
  </div>
</div>

<!-- background and car must be in /assets/ as specified -->
<audio id="bgm" src="assets/music.mp3" loop preload="auto"></audio>

<script>
/* ---------- config ---------- */
const BG_SRC = 'assets/background.png'; // chosen background (use this exact path)
const CAR_SRC = 'assets/car.png';       // put your car PNG here (transparent)
const CANVAS_BASE_W = 420; // base canvas width
const CANVAS_BASE_H = 720; // base canvas height

/* ---------- state ---------- */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d', { alpha: true });

const overlay = document.getElementById('overlay');
const overlayTitle = document.getElementById('overlayTitle');
const finalScoreEl = document.getElementById('finalScore');
const restartBtn = document.getElementById('restartBtn');
const backBtn = document.getElementById('backBtn');
const heartsBox = document.getElementById('hearts');
const scoreEl = document.getElementById('score');

const leftBtn = document.getElementById('left');
const rightBtn = document.getElementById('right');
const audio = document.getElementById('bgm');

let w = canvas.width, h = canvas.height;
let scale = 1;

let bgImg = new Image();
let carImg = new Image();
bgImg.src = BG_SRC;
carImg.src = CAR_SRC;

let offsetY = 0; // scrolling offset
let speedMultiplier = 1;
let car = { x: 0, y: 0, w: 80, h: 120 };
let keys = { left:false, right:false };
let pointerDown = false;
let lives = 3;
let score = 0;
let obstacles = [];
let lastSpawn = 0;
let running = true;

/* ---------- helpers ---------- */
function resizeCanvas(){
  // Keep aspect ratio and make canvas fit width of screen sensibly
  const vw = Math.min(window.innerWidth, 980);
  scale = vw / CANVAS_BASE_W;
  canvas.style.width = (CANVAS_BASE_W*scale) + 'px';
  canvas.style.height = (CANVAS_BASE_H*scale) + 'px';
  // keep internal size fixed for crispness
  w = CANVAS_BASE_W; h = CANVAS_BASE_H;
  canvas.width = w; canvas.height = h;
  // update car size relative to canvas
  car.w = Math.round(w * 0.14);
  car.h = Math.round(car.w * 1.35);
  car.x = (w - car.w)/2;
  car.y = h - car.h - Math.round(h*0.04);
}
window.addEventListener('resize', resizeCanvas);

/* hearts UI */
function renderHearts(){
  heartsBox.innerHTML = '';
  for(let i=0;i<3;i++){
    const div = document.createElement('div');
    div.className = 'heart';
    div.style.opacity = (i < lives) ? '1' : '0.25';
    heartsBox.appendChild(div);
  }
}

/* play music handling
   We try to play right away if sessionStorage flag exists (user clicked Start).
   Otherwise we will wait for the first user interaction to start audio.
*/
function tryStartMusic(){
  const hadGesture = sessionStorage.getItem('birthday_gesture');
  if(hadGesture){
    audio.play().catch(()=>{}); // attempt; if blocked, will play on first input below
  }
}
document.addEventListener('pointerdown', ()=> { audio.play().catch(()=>{}); }, { once: true });

/* ---------- game logic ---------- */
function spawnObstacle(){
  // simple obstacle: rectangle lane-style
  const width = Math.round(w * 0.14);
  const x = Math.random() * (w - width - 20) + 10;
  const speed = 2 + Math.random()*2 + score*0.01;
  obstacles.push({ x, y: -80, w: width, h: Math.round(width*0.6), speed });
}

function checkCollision(a,b){
  return !(a.x + a.w < b.x || a.x > b.x + b.w || a.y + a.h < b.y || a.y > b.y + b.h);
}

function update(dt){
  if(!running) return;

  // move car by keys
  const moveSpeed = Math.max(4, w*0.006) * (1 + Math.min(1, score/100));
  if(keys.left) car.x -= moveSpeed;
  if(keys.right) car.x += moveSpeed;
  // clamp
  car.x = Math.max(8, Math.min(car.x, w - car.w - 8));

  // scroll background
  offsetY += 180 * dt * 0.001 * (1 + score*0.002); // base speed times dt
  if(offsetY > h) offsetY = offsetY - h;

  // spawn
  if(performance.now() - lastSpawn > Math.max(400, 1000 - score*4)){
    if(Math.random() < 0.78) spawnObstacle();
    lastSpawn = performance.now();
  }

  // update obstacles
  for(let i=obstacles.length-1;i>=0;i--){
    const o = obstacles[i];
    o.y += o.speed * (1 + score*0.005) * dt * 0.03;
    // collision detection: create rects in same coordinate system
    const carRect = {x: car.x, y: car.y, w: car.w, h: car.h};
    const oRect = {x: o.x, y: o.y, w: o.w, h: o.h};
    if(checkCollision(carRect, oRect)){
      // hit — lose life
      obstacles.splice(i,1);
      lives = Math.max(0, lives-1);
      renderHearts();
      // shake effect
      canvas.animate([{ transform:'translateX(0)'}, { transform:'translateX(-8px)'}, { transform:'translateX(8px)'}, { transform:'translateX(0)'}], { duration:260 });
      if(lives === 0){
        gameOver();
        return;
      }
    } else if(o.y > h + 30){
      // missed obstacle — remove
      obstacles.splice(i,1);
      // optional: small score penalty? we keep score on pickups only
    }
  }

  // increase score slowly over time
  score += Math.floor(dt * 0.01);
  scoreEl.textContent = 'Score: ' + score;
}

/* draw */
function draw(){
  // clear
  ctx.clearRect(0,0,w,h);

  // draw two tiled background images vertically to scroll
  if(bgImg.complete){
    // scale background to fit width while preserving aspect ratio
    const imgW = bgImg.width, imgH = bgImg.height;
    const scaleBg = w / imgW;
    const bgHscaled = imgH * scaleBg;
    // draw two copies stacked vertically so scrolling loops
    const y1 = - (offsetY % bgHscaled);
    ctx.drawImage(bgImg, 0, 0, imgW, imgH, 0, y1, w, bgHscaled);
    ctx.drawImage(bgImg, 0, 0, imgW, imgH, 0, y1 + bgHscaled, w, bgHscaled);
  } else {
    // fallback background
    ctx.fillStyle = '#071028';
    ctx.fillRect(0,0,w,h);
  }

  // road tint overlay to ensure contrast
  ctx.fillStyle = 'rgba(0,0,0,0.12)';
  ctx.fillRect(0,0,w,h);

  // draw obstacles (simple rectangles with slight styling)
  obstacles.forEach(o => {
    ctx.save();
    ctx.fillStyle = '#333';
    ctx.strokeStyle = '#111';
    ctx.lineWidth = 2;
    ctx.fillRect(o.x, o.y, o.w, o.h);
    ctx.strokeRect(o.x, o.y, o.w, o.h);
    ctx.restore();
  });

  // draw car (centered at car.x, car.y)
  if(carImg.complete){
    // draw car scaled into car.w x car.h
    ctx.drawImage(carImg, 0, 0, carImg.width, carImg.height, Math.round(car.x), Math.round(car.y), Math.round(car.w), Math.round(car.h));
  } else {
    // fallback rectangle
    ctx.fillStyle = '#ff3a6e';
    ctx.fillRect(Math.round(car.x), Math.round(car.y), Math.round(car.w), Math.round(car.h));
  }
}

/* game loop */
let last = performance.now();
function loop(now){
  const dt = now - last;
  update(dt);
  draw();
  last = now;
  requestAnimationFrame(loop);
}

/* start / stop */
function startGame(){
  running = true;
  overlay.style.display = 'none';
  score = 0;
  lives = 3;
  obstacles = [];
  renderHearts();
  scoreEl.textContent = 'Score: 0';
  last = performance.now();
  requestAnimationFrame(loop);
  tryStartMusic();
}

function gameOver(){
  running = false;
  overlayTitle.textContent = 'Game Over';
  finalScoreEl.textContent = score;
  overlay.style.display = 'flex';
}

/* restart handler */
restartBtn.addEventListener('click', ()=> {
  startGame();
});

/* back to card */
backBtn.addEventListener('click', ()=> {
  // stop music
  audio.pause();
  sessionStorage.removeItem('birthday_gesture');
  location.href = 'index.html';
});

/* input handlers */
window.addEventListener('keydown', (e)=>{
  if(e.key === 'ArrowLeft') keys.left = true;
  if(e.key === 'ArrowRight') keys.right = true;
  if(e.key === ' '){ // space to pause
    running = !running;
    overlay.style.display = running ? 'none' : 'flex';
    overlayTitle.textContent = running ? 'Paused' : 'Paused';
    finalScoreEl.textContent = score;
  }
});
window.addEventListener('keyup', (e)=>{
  if(e.key === 'ArrowLeft') keys.left = false;
  if(e.key === 'ArrowRight') keys.right = false;
});

/* touch / pointer controls */
leftBtn.addEventListener('pointerdown', ()=> keys.left = true);
leftBtn.addEventListener('pointerup', ()=> keys.left = false);
leftBtn.addEventListener('pointercancel', ()=> keys.left = false);
rightBtn.addEventListener('pointerdown', ()=> keys.right = true);
rightBtn.addEventListener('pointerup', ()=> keys.right = false);
rightBtn.addEventListener('pointercancel', ()=> keys.right = false);

// drag support: drag on canvas to steer
let pointerId = null;
canvas.addEventListener('pointerdown', (e)=>{
  pointerDown = true;
  pointerId = e.pointerId;
  canvas.setPointerCapture(pointerId);
});
canvas.addEventListener('pointerup', (e)=>{
  pointerDown = false;
  if(pointerId !== null) canvas.releasePointerCapture(pointerId);
  pointerId = null;
  keys.left = keys.right = false;
});
canvas.addEventListener('pointermove', (e)=>{
  if(!pointerDown) return;
  // translate pointer x into car.x
  const rect = canvas.getBoundingClientRect();
  const relX = (e.clientX - rect.left) * (canvas.width / rect.width);
  // smooth follow: set car.x toward relX - car.w/2
  const target = relX - car.w/2;
  car.x += (target - car.x) * 0.25;
});

/* spawn interval & start */
resizeCanvas();
renderHearts();

// Attempt to autoplay music if gesture exists
tryStartMusic();

// on first load, if sessionStorage had the gesture we started earlier, start the game immediately
if(sessionStorage.getItem('birthday_gesture')){
  // give tiny timeout to ensure UI is ready
  setTimeout(()=> startGame(), 90);
} else {
  // no pre-gesture — show overlay that tells user to tap to start (to allow sound)
  overlayTitle.textContent = 'Tap to Start';
  overlay.style.display = 'flex';
  overlayMessage = document.getElementById('overlayMessage') || null;
  finalScoreEl.textContent = score;
  // clicking anywhere will start and trigger audio (user gesture)
  function firstStart() {
    startGame();
    document.removeEventListener('pointerdown', firstStart);
  }
  document.addEventListener('pointerdown', firstStart, { once: true });
}

// basic spawn frequency
setInterval(()=> {
  if(running && Math.random() < 0.9) spawnObstacle();
}, 900);

/* small confetti when score hits multiples of 50 */
setInterval(()=>{
  if(!running) return;
  if(score > 0 && score % 50 === 0){
    for(let i=0;i<18;i++){
      const sp = document.createElement('div');
      sp.style.position = 'fixed';
      sp.style.left = (Math.random()*100)+'vw';
      sp.style.top = (Math.random()*100)+'vh';
      sp.style.width = '8px';
      sp.style.height = '8px';
      sp.style.borderRadius = '2px';
      sp.style.background = ['#ff6aa6','#ffd166','#6ee7b7','#8b5cf6'][Math.floor(Math.random()*4)];
      sp.style.zIndex = 9999;
      sp.style.pointerEvents = 'none';
      document.body.appendChild(sp);
      sp.animate([{ transform:'translateY(0) rotate(0deg)'},{ transform:'translateY(60px) rotate(180deg)' }], { duration: 1000 + Math.random()*800 });
      setTimeout(()=> sp.remove(), 1400);
    }
  }
}, 1000);

</script>
  <script src="script.js"></script>
</body>
</html>
